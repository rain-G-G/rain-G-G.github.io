<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wxyy97.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="普通Notification的布局以及发送流程">
<meta property="og:type" content="article">
<meta property="og:title" content="Notification的基本布局和发送流程">
<meta property="og:url" content="http://wxyy97.com/2022/04/10/Notification%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B8%83%E5%B1%80%E5%92%8C%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="Rain.G">
<meta property="og:description" content="普通Notification的布局以及发送流程">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://wxyy97.com/image/notification_shu.jpg">
<meta property="og:image" content="http://wxyy97.com/image/notification_heng.jpg">
<meta property="og:image" content="http://wxyy97.com/image/notification_buju.jpg">
<meta property="og:image" content="http://wxyy97.com/image/notification_sortdemo.jpg">
<meta property="og:image" content="http://wxyy97.com/image/notification_systemui.jpg">
<meta property="article:published_time" content="2022-04-10T02:53:52.000Z">
<meta property="article:modified_time" content="2022-04-10T03:39:49.369Z">
<meta property="article:author" content="Rain.G">
<meta property="article:tag" content="Rain.G">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://wxyy97.com/image/notification_shu.jpg">

<link rel="canonical" href="http://wxyy97.com/2022/04/10/Notification%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B8%83%E5%B1%80%E5%92%8C%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Notification的基本布局和发送流程 | Rain.G</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Rain.G</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Rain.G</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/rain-G-G" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://wxyy97.com/2022/04/10/Notification%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%B8%83%E5%B1%80%E5%92%8C%E5%8F%91%E9%80%81%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/wx.JPG">
      <meta itemprop="name" content="Rain.G">
      <meta itemprop="description" content="愿你一生努力，一生被爱">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rain.G">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Notification的基本布局和发送流程
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-04-10 10:53:52 / Modified: 11:39:49" itemprop="dateCreated datePublished" datetime="2022-04-10T10:53:52+08:00">2022-04-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android-%E5%BA%94%E7%94%A8%E5%B1%82/" itemprop="url" rel="index"><span itemprop="name">Android 应用层</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android-%E5%BA%94%E7%94%A8%E5%B1%82/SystemUI/" itemprop="url" rel="index"><span itemprop="name">SystemUI</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Android-%E5%BA%94%E7%94%A8%E5%B1%82/SystemUI/Notification/" itemprop="url" rel="index"><span itemprop="name">Notification</span></a>
                </span>
            </span>

          
            <div class="post-description">普通Notification的布局以及发送流程</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h5 id="一、通知栏界面如下："><a href="#一、通知栏界面如下：" class="headerlink" title="一、通知栏界面如下："></a>一、通知栏界面如下：</h5><p>竖屏：</p>
<img src="http://wxyy97.com/image/notification_shu.jpg" style="zoom:50%;" />

<p>横屏：</p>
<img src="http://wxyy97.com/image/notification_heng.jpg" style="zoom: 33%;" />

<p><strong>1、横屏有个情况是从左边下滑，通知栏从左边下滑，右边和中间同理。</strong></p>
<p>修改方案：<code>framework/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/NotificationPanelView.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updateVerticalPanelPosition</span><span class="params">(<span class="keyword">float</span> x)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mNotificationStackScroller.getWidth() * <span class="number">1.75f</span> &gt; getWidth()) &#123;</span><br><span class="line">           resetHorizontalPanelPosition();</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">float</span> leftMost = mPositionMinSideMargin + mNotificationStackScroller.getWidth() / <span class="number">2</span>;</span><br><span class="line">       <span class="keyword">float</span> rightMost = getWidth() - mPositionMinSideMargin</span><br><span class="line">               - mNotificationStackScroller.getWidth() / <span class="number">2</span>;</span><br><span class="line">       <span class="keyword">if</span> (Math.abs(x - getWidth() / <span class="number">2</span>) &lt; mNotificationStackScroller.getWidth() / <span class="number">4</span>) &#123;</span><br><span class="line">           x = getWidth() / <span class="number">2</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       x = Math.min(rightMost, Math.max(leftMost, x));</span><br><span class="line">       <span class="keyword">float</span> center =</span><br><span class="line">               mNotificationStackScroller.getLeft() + mNotificationStackScroller.getWidth() / <span class="number">2</span>;</span><br><span class="line">       <span class="comment">//setHorizontalPanelTranslation(x - center);</span></span><br><span class="line">       setHorizontalPanelTranslation(<span class="number">0f</span>);<span class="comment">//mod by wx 横屏下无论从左右中下拉状态栏 都从中间出来</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>大体上就是接收<code>touch</code>事件，获取x坐标、平移，具体流程有时间再分析吧。</p>
<p><strong>2、整个通知界面布局：</strong></p>
<p><img src="http://wxyy97.com/image/notification_buju.jpg" alt=""></p>
<ul>
<li><p><code>StatusBarWindowView</code>                                               SystemUI的根布局</p>
</li>
<li><p><code>NotificationPanelView(notification_panel)</code>         默认隐藏，接收到下拉操作后显示，包含锁屏的一些界面(比如锁屏的时间)</p>
</li>
<li><p><code>NotificationsQuickSettingsContainer(notification_container_parent)</code>      俩部分：一是快捷面板(id/qs_frame)，二是通知根布局(id/notification_stack_scroller)</p>
</li>
<li><p><code>NotificationStackScrollLayout(notification_stack_scroller)</code>                 通知的根布局</p>
</li>
</ul>
<p><strong>3、关于通知根布局的布局以及部分间距问题：</strong></p>
<p>（1）在根布局<code>id/notification_stack_scroller</code>里，一个通知即为一个<code>ExpandableNotificationRow</code>，下面是官方介绍：</p>
<p><code>View representing a notification item - this can be either the individual child notification or the group summary (which contains 1 or more child notifications).</code>表示通知项的视图- 可以是单个子通知，也可以是组摘要（包含一个或多个子通知）。</p>
<p>（2）每个通知长按后会出现<code>NotificationGuts</code>界面，即上面第一张图中的Android系统界面，使其成为圆角:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">childNeedsClipping</span><span class="params">(View child)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// add by wx</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一张图中给每个通知后面都有轮廓线条，导致后面的四个边角全部凸显出来，方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">needsOutline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// add by wx for 去掉通知外形轮廓的那条线</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="二、Notification"><a href="#二、Notification" class="headerlink" title="二、Notification"></a>二、Notification</h5><h6 id="1、使用：Notification-Rain-G"><a href="#1、使用：Notification-Rain-G" class="headerlink" title="1、使用：Notification | Rain.G"></a><strong>1、使用</strong>：<a href="http://wxyy97.com/2021/04/22/Notification/">Notification | Rain.G</a></h6><h6 id="2、实现原理："><a href="#2、实现原理：" class="headerlink" title="2、实现原理："></a>2、实现原理：</h6><p><a href="https://blog.csdn.net/zhao5214319/article/details/98848708?utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~aggregatepage~first_rank_ecpm_v1~rank_v31_ecpm-1-98848708.pc_agg_new_rank&utm_term=PostNotificationRunnable&spm=1000.2123.3001.4430" target="_blank" rel="noopener">Android 发送通知Framework</a></p>
<blockquote>
<p>服务端(System进程)：NM发送 -&gt; NMS处理 -&gt; NMS 将通知post给监听器 -&gt;<br>客户端(SystemUI)：Sysui接收 -&gt; 根据通知类型加载对应通知布局 -&gt; 显示</p>
</blockquote>
<p><strong>（1）NotificationManager 预处理通知</strong></p>
<p>从上面的使用可知，最后发送是通过<code>NotificationManager.notify()</code>发送的，定位到<code>frameworks/base/core/java/android/app/NotificationManager.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UnsupportedAppUsage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyAsUser</span><span class="params">(String tag, <span class="keyword">int</span> id, Notification notification, UserHandle user)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        INotificationManager service = getService();</span><br><span class="line">        String pkg = mContext.getPackageName();</span><br><span class="line">        <span class="keyword">if</span>(pkg.contains(<span class="string">".qti"</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Log.v(TAG, pkg + <span class="string">": notify("</span> + id + <span class="string">", "</span> + notification + <span class="string">")"</span>);</span><br><span class="line">            service.enqueueNotificationWithTag(pkg, mContext.getOpPackageName(), tag, id,</span><br><span class="line">                    fixNotification(notification), user.getIdentifier());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Notification <span class="title">fixNotification</span><span class="params">(Notification notification)</span> </span>&#123;</span><br><span class="line">        String pkg = mContext.getPackageName();</span><br><span class="line">        <span class="comment">// Fix the notification as best we can.</span></span><br><span class="line">        Notification.addFieldsFromContext(mContext, notification);</span><br><span class="line">        <span class="comment">//修正sound</span></span><br><span class="line">        <span class="keyword">if</span> (notification.sound != <span class="keyword">null</span>) &#123;</span><br><span class="line">            notification.sound = notification.sound.getCanonicalUri();</span><br><span class="line">            <span class="keyword">if</span> (StrictMode.vmFileUriExposureEnabled()) &#123;</span><br><span class="line">                notification.sound.checkFileUriExposed(<span class="string">"Notification.sound"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//兼容旧版本smallIcon设置接口</span></span><br><span class="line">        fixLegacySmallIcon(notification, pkg);</span><br><span class="line">        <span class="comment">//小图标异常处理</span></span><br><span class="line">        <span class="keyword">if</span> (mContext.getApplicationInfo().targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">            <span class="keyword">if</span> (notification.getSmallIcon() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid notification (no valid small icon): "</span></span><br><span class="line">                        + notification);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//裁剪通知中包含的图片的大小,避免用户设置的图片太大</span></span><br><span class="line">        notification.reduceImageSizes(mContext);</span><br><span class="line">        <span class="comment">//低内存设备兼容</span></span><br><span class="line">        ActivityManager am = (ActivityManager) mContext.getSystemService(Context.ACTIVITY_SERVICE);</span><br><span class="line">        <span class="keyword">boolean</span> isLowRam = am.isLowRamDevice();</span><br><span class="line">        <span class="keyword">return</span> Builder.maybeCloneStrippedForDelivery(notification, isLowRam, mContext);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>fixNotification</code>方法对通知做了简单修正，如 smallIcon 处理，图片资源裁剪处理，低内存兼容等，说明下步骤1：<strong>在SDK版本大于22之后，Android强制要求用户设置 smallIcon 了，否则会报异常，所以我们发送通知的时候，smallIcon必须设置。</strong></p>
<p>做完简单修正处理后，<code>NotificationManager</code>就直接将流程交给NMS了，接下来看NMS的处理流程。</p>
<p><strong>（2）入列预处理</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueueNotificationInternal</span><span class="params">(<span class="keyword">final</span> String pkg, <span class="keyword">final</span> String opPkg, <span class="keyword">final</span> <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">final</span> <span class="keyword">int</span> callingPid, <span class="keyword">final</span> String tag, <span class="keyword">final</span> <span class="keyword">int</span> id, <span class="keyword">final</span> Notification notification,</span></span></span><br><span class="line"><span class="function"><span class="params">           <span class="keyword">int</span> incomingUserId)</span> </span>&#123;</span><br><span class="line">       ...</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> userId = ActivityManager.handleIncomingUser(callingPid,</span><br><span class="line">               callingUid, incomingUserId, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="string">"enqueueNotification"</span>, pkg);</span><br><span class="line">       <span class="keyword">final</span> UserHandle user = UserHandle.of(userId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Can throw a SecurityException if the calling uid doesn't have permission to post</span></span><br><span class="line">       <span class="comment">// as "pkg"</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> notificationUid = resolveNotificationUid(opPkg, pkg, callingUid, userId);</span><br><span class="line"></span><br><span class="line">       checkRestrictedCategories(notification);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Fix the notification as best we can.</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           fixNotification(notification, pkg, userId);</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">           Slog.e(TAG, <span class="string">"Cannot create a context for sending app"</span>, e);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mUsageStats.registerEnqueuedByApp(pkg);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// setup local book-keeping</span></span><br><span class="line">       String channelId = notification.getChannelId();</span><br><span class="line">       <span class="keyword">if</span> (mIsTelevision &amp;&amp; (<span class="keyword">new</span> Notification.TvExtender(notification)).getChannelId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">           channelId = (<span class="keyword">new</span> Notification.TvExtender(notification)).getChannelId();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//Android 8.0之后不设置channel的通知是无法发送的，源码就是在这里做的限制</span></span><br><span class="line">       <span class="keyword">final</span> NotificationChannel channel = mPreferencesHelper.getNotificationChannel(pkg,</span><br><span class="line">               notificationUid, channelId, <span class="keyword">false</span> <span class="comment">/* includeDeleted */</span>);</span><br><span class="line">       <span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> String noChannelStr = <span class="string">"No Channel found for "</span></span><br><span class="line">                   + <span class="string">"pkg="</span> + pkg</span><br><span class="line">                   + <span class="string">", channelId="</span> + channelId</span><br><span class="line">                   + <span class="string">", id="</span> + id</span><br><span class="line">                   + <span class="string">", tag="</span> + tag</span><br><span class="line">                   + <span class="string">", opPkg="</span> + opPkg</span><br><span class="line">                   + <span class="string">", callingUid="</span> + callingUid</span><br><span class="line">                   + <span class="string">", userId="</span> + userId</span><br><span class="line">                   + <span class="string">", incomingUserId="</span> + incomingUserId</span><br><span class="line">                   + <span class="string">", notificationUid="</span> + notificationUid</span><br><span class="line">                   + <span class="string">", notification="</span> + notification;</span><br><span class="line">           Slog.e(TAG, noChannelStr);</span><br><span class="line">           <span class="keyword">boolean</span> appNotificationsOff = mPreferencesHelper.getImportance(pkg, notificationUid)</span><br><span class="line">                   == NotificationManager.IMPORTANCE_NONE;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!appNotificationsOff) &#123;</span><br><span class="line">               doChannelWarningToast(<span class="string">"Developer warning for package \""</span> + pkg + <span class="string">"\"\n"</span> +</span><br><span class="line">                       <span class="string">"Failed to post notification on channel \""</span> + channelId + <span class="string">"\"\n"</span> +</span><br><span class="line">                       <span class="string">"See log for more details"</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//面向客户端的`Notification`的包装类，包含部分信息</span></span><br><span class="line">       <span class="keyword">final</span> StatusBarNotification n = <span class="keyword">new</span> StatusBarNotification(</span><br><span class="line">               pkg, opPkg, id, tag, notificationUid, callingPid, notification,</span><br><span class="line">               user, <span class="keyword">null</span>, System.currentTimeMillis());</span><br><span class="line">       <span class="comment">//面向服务端的`Notification`的包装类，包含全部信息</span></span><br><span class="line">       <span class="keyword">final</span> NotificationRecord r = <span class="keyword">new</span> NotificationRecord(getContext(), n, channel);</span><br><span class="line">       r.setIsAppImportanceLocked(mPreferencesHelper.getIsAppImportanceLocked(pkg, callingUid));</span><br><span class="line"></span><br><span class="line">       <span class="comment">//前台服务channel处理</span></span><br><span class="line">       <span class="keyword">if</span> ((notification.flags &amp; Notification.FLAG_FOREGROUND_SERVICE) != <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> fgServiceShown = channel.isFgServiceShown();</span><br><span class="line">           <span class="keyword">if</span> (((channel.getUserLockedFields() &amp; NotificationChannel.USER_LOCKED_IMPORTANCE) == <span class="number">0</span></span><br><span class="line">                       || !fgServiceShown)</span><br><span class="line">                   &amp;&amp; (r.getImportance() == IMPORTANCE_MIN</span><br><span class="line">                           || r.getImportance() == IMPORTANCE_NONE)) &#123;</span><br><span class="line">               <span class="comment">// Increase the importance of foreground service notifications unless the user had</span></span><br><span class="line">               <span class="comment">// an opinion otherwise (and the channel hasn't yet shown a fg service).</span></span><br><span class="line">               <span class="keyword">if</span> (TextUtils.isEmpty(channelId)</span><br><span class="line">                       || NotificationChannel.DEFAULT_CHANNEL_ID.equals(channelId)) &#123;</span><br><span class="line">                   r.setSystemImportance(IMPORTANCE_LOW);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   channel.setImportance(IMPORTANCE_LOW);</span><br><span class="line">                   r.setSystemImportance(IMPORTANCE_LOW);</span><br><span class="line">                   <span class="keyword">if</span> (!fgServiceShown) &#123;</span><br><span class="line">                       channel.unlockFields(NotificationChannel.USER_LOCKED_IMPORTANCE);</span><br><span class="line">                       channel.setFgServiceShown(<span class="keyword">true</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">                   mPreferencesHelper.updateNotificationChannel(</span><br><span class="line">                           pkg, notificationUid, channel, <span class="keyword">false</span>);</span><br><span class="line">                   r.updateNotificationChannel(channel);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!fgServiceShown &amp;&amp; !TextUtils.isEmpty(channelId)</span><br><span class="line">                   &amp;&amp; !NotificationChannel.DEFAULT_CHANNEL_ID.equals(channelId)) &#123;</span><br><span class="line">               channel.setFgServiceShown(<span class="keyword">true</span>);</span><br><span class="line">               r.updateNotificationChannel(channel);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//检查通知发送速率、数量(最多25个)、Snoozed是否可以发出去</span></span><br><span class="line">       <span class="comment">//当用户在设置中设置了不允许显示某应用的通知(blocked)时,不再发送</span></span><br><span class="line">       <span class="keyword">if</span> (!checkDisqualifyingFeatures(userId, notificationUid, id, tag, r,</span><br><span class="line">               r.sbn.getOverrideGroupKey() != <span class="keyword">null</span>)) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Whitelist pending intents.</span></span><br><span class="line">       <span class="keyword">if</span> (notification.allPendingIntents != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> intentCount = notification.allPendingIntents.size();</span><br><span class="line">           <span class="keyword">if</span> (intentCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">final</span> ActivityManagerInternal am = LocalServices</span><br><span class="line">                       .getService(ActivityManagerInternal<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">long</span> duration = LocalServices.getService(</span><br><span class="line">                       DeviceIdleController.LocalService<span class="class">.<span class="keyword">class</span>).<span class="title">getNotificationWhitelistDuration</span>()</span>;</span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; intentCount; i++) &#123;</span><br><span class="line">                   PendingIntent pendingIntent = notification.allPendingIntents.valueAt(i);</span><br><span class="line">                   <span class="keyword">if</span> (pendingIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       am.setPendingIntentWhitelistDuration(pendingIntent.getTarget(),</span><br><span class="line">                               WHITELIST_TOKEN, duration);</span><br><span class="line">                       am.setPendingIntentAllowBgActivityStarts(pendingIntent.getTarget(),</span><br><span class="line">                               WHITELIST_TOKEN, (FLAG_ACTIVITY_SENDER | FLAG_BROADCAST_SENDER</span><br><span class="line">                                       | FLAG_SERVICE_SENDER));</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       mHandler.post(<span class="keyword">new</span> EnqueueNotificationRunnable(userId, r));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>StatusBarNotification</code>是一个<strong>面向客户端的<code>Notification</code>的包装类</strong>，仅包含用户需要知道的通知相关的信息，如通知包名、id、key等信息，最终NMS将新通知回调给监听者的时候，给客户端的就是该对象</li>
<li><code>NotificationRecord</code>是<strong>面向服务端的<code>Notification</code>的包装类</strong>，除了持有<code>StatusBarNotification</code>实例外，还封装了各种通知相关的信息，如<code>channel、sound(通知铃声)、vibration(震动效果)</code>等等，这些信息在服务端处理通知的时候需要用到，但客户端并不需要关心这些</li>
</ul>
<p>通知入列，将通知发送流程交给<code>EnqueueNotificationRunnable</code></p>
<p><strong>先解释几个概念：</strong></p>
<ol>
<li>下文会出现 <strong>旧通知 和 新通知</strong> 这两个说法，指的是两条”相同”的通知，这里的相同指的是<code>StatusBarNotification.key</code>相同，NMS中维护了一个<code>mNotificationsByKey</code>数据集合，该集合以<code>StatusBarNotification.key</code>为key，以<code>NotificationRecord</code>为value，维护着当前的通知列表，其中key的构造是在<code>StatusBarNotification</code>的构造函数中完成的，构造过程如下：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">key</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String sbnKey = user.getIdentifier() + <span class="string">"|"</span> + pkg + <span class="string">"|"</span> + id + <span class="string">"|"</span> + tag + <span class="string">"|"</span> + uid;</span><br><span class="line">    <span class="keyword">if</span> (overrideGroupKey != <span class="keyword">null</span> &amp;&amp; getNotification().isGroupSummary()) &#123;</span><br><span class="line">        sbnKey = sbnKey + <span class="string">"|"</span> + overrideGroupKey;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sbnKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是我们前后以相同的key发送一条通知时，系统根据这个key就可以从<code>mNotificationsByKey</code>中获取到旧通知，例如更新类型的通知(微信个人的消息，音乐软件的通知等)；而新通知自然就是新来的这条要更新的通知了。</p>
<ol start="2">
<li>NMS维护了几个主要的数据结构，分别用在不同的场景下，先说明下，后续阅读源码的时候如果困惑就回头再来看看这个总结吧：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/NotificationManagerSevice.java*/</span></span><br><span class="line"><span class="comment">// 服务端维护的 已排序 的通知</span></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;NotificationRecord&gt; mNotificationList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">// 服务端维护的 未排序 的通知</span></span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;String, NotificationRecord&gt; mNotificationsByKey = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line"><span class="comment">//  "入列通知"，通知入列的时候被记录，当某通知成功发送后则会被从该集合中移除，所以最终该集合记录的是所有入列成功但发送不成功的通知</span></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;NotificationRecord&gt; mEnqueuedNotifications = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">// 前面我们说过，当应用未主动为通知设置组别时，系统也会去做这件事，该集合记录的就是这些系统成组的父通知，</span></span><br><span class="line"><span class="comment">// 也就是每次系统帮某用户的某个应用创建了一条父通知，则该父通知会被记录进该集合，</span></span><br><span class="line"><span class="comment">// key - value 为：ArrayMap&lt;userId, ArrayMap&lt;pkg, summarySbnKey&gt;&gt;</span></span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;Integer, ArrayMap&lt;String, String&gt;&gt; mAutobundledSummaries = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line"><span class="comment">// 服务端根据groupKey，维护着所有用户主动成组的父通知，主要在`EnqueueNotificationRunnable`中处理分组通知的时候使用</span></span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;String, NotificationRecord&gt; mSummaryByGroupKey = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>分组的概念: Android允许应用主动将发送出来的多条通知以组的形式显示在一起,并通过<code>goupKey</code>区分组别，这样可以避免同个应用的多条通知占据了通知面板的大量显示空间，同时，<strong>如果应用未主动将多条通知成组，则系统也会去做这个事情</strong>，例如Android Q上面在同个应用的通知数达到4条的时候就会将其成组显示。</li>
</ol>
<p><strong>（3）通知入列</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">EnqueueNotificationRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> NotificationRecord r;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> userId;</span><br><span class="line">        ...</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mNotificationLock) &#123;</span><br><span class="line">                <span class="comment">//存到集合，后续会用到</span></span><br><span class="line">                mEnqueuedNotifications.add(r);</span><br><span class="line">                <span class="comment">//当用户设置了 Builder.setTimeoutAfter(long durationMs) 则会在这里做处理</span></span><br><span class="line">                scheduleTimeoutLocked(r);</span><br><span class="line">                <span class="comment">//从集合mNotificationsByKey中取出旧通知</span></span><br><span class="line">                <span class="keyword">final</span> StatusBarNotification n = r.sbn;</span><br><span class="line">                <span class="keyword">if</span> (DBG) Slog.d(TAG, <span class="string">"EnqueueNotificationRunnable.run for: "</span> + n.getKey());</span><br><span class="line">                NotificationRecord old = mNotificationsByKey.get(n.getKey());</span><br><span class="line">                <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Retain ranking information from previous record</span></span><br><span class="line">                    r.copyRankingInformation(old);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> callingUid = n.getUid();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> callingPid = n.getInitialPid();</span><br><span class="line">                <span class="keyword">final</span> Notification notification = n.getNotification();</span><br><span class="line">                <span class="keyword">final</span> String pkg = n.getPackageName();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> id = n.getId();</span><br><span class="line">                <span class="keyword">final</span> String tag = n.getTag();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// We need to fix the notification up a little for bubbles</span></span><br><span class="line">                flagNotificationForBubbles(r, pkg, callingUid, old);<span class="comment">//更新通知是不是气泡的flag</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Handle grouped notifications and bail out early if we</span></span><br><span class="line">                <span class="comment">// can to avoid extracting signals.</span></span><br><span class="line">                <span class="comment">// 分组处理</span></span><br><span class="line">                handleGroupedNotificationLocked(r, old, callingUid, callingPid);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// if this is a group child, unsnooze parent summary</span></span><br><span class="line">                <span class="keyword">if</span> (n.isGroup() &amp;&amp; notification.isGroupChild()) &#123;</span><br><span class="line">                    mSnoozeHelper.repostGroupSummary(pkg, r.getUserId(), n.getGroupKey());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// This conditional is a dirty hack to limit the logging done on</span></span><br><span class="line">                <span class="comment">//     behalf of the download manager without affecting other apps.</span></span><br><span class="line">                <span class="keyword">if</span> (!pkg.equals(<span class="string">"com.android.providers.downloads"</span>)</span><br><span class="line">                        || Log.isLoggable(<span class="string">"DownloadManager"</span>, Log.VERBOSE)) &#123;</span><br><span class="line">                    <span class="keyword">int</span> enqueueStatus = EVENTLOG_ENQUEUE_STATUS_NEW;</span><br><span class="line">                    <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        enqueueStatus = EVENTLOG_ENQUEUE_STATUS_UPDATE;</span><br><span class="line">                    &#125;</span><br><span class="line">                    EventLogTags.writeNotificationEnqueue(callingUid, callingPid,</span><br><span class="line">                            pkg, id, tag, userId, notification.toString(),</span><br><span class="line">                            enqueueStatus);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// tell the assistant service about the notification</span></span><br><span class="line">                <span class="comment">// post通知</span></span><br><span class="line">                <span class="keyword">if</span> (mAssistants.isEnabled()) &#123;</span><br><span class="line">                    mAssistants.onNotificationEnqueuedLocked(r);</span><br><span class="line">                    mHandler.postDelayed(<span class="keyword">new</span> PostNotificationRunnable(r.getKey()),</span><br><span class="line">                            DELAY_FOR_ASSISTANT_TIME);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mHandler.post(<span class="keyword">new</span> PostNotificationRunnable(r.getKey()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleGroupedNotificationLocked</span><span class="params">(NotificationRecord r, NotificationRecord old,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> callingUid, <span class="keyword">int</span> callingPid)</span> </span>&#123;</span><br><span class="line">        StatusBarNotification sbn = r.sbn;</span><br><span class="line">        Notification n = sbn.getNotification();</span><br><span class="line">        <span class="comment">// 步骤1</span></span><br><span class="line">        <span class="keyword">if</span> (n.isGroupSummary() &amp;&amp; !sbn.isAppGroup())  &#123;</span><br><span class="line">            <span class="comment">// notifications without a group shouldn't be a summary, otherwise autobundling can</span></span><br><span class="line">            <span class="comment">// lead to bugs</span></span><br><span class="line">            n.flags &amp;= ~Notification.FLAG_GROUP_SUMMARY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String group = sbn.getGroupKey();</span><br><span class="line">        <span class="keyword">boolean</span> isSummary = n.isGroupSummary();</span><br><span class="line"></span><br><span class="line">        Notification oldN = old != <span class="keyword">null</span> ? old.sbn.getNotification() : <span class="keyword">null</span>;</span><br><span class="line">        String oldGroup = old != <span class="keyword">null</span> ? old.sbn.getGroupKey() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> oldIsSummary = old != <span class="keyword">null</span> &amp;&amp; oldN.isGroupSummary();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 步骤2</span></span><br><span class="line">        <span class="keyword">if</span> (oldIsSummary) &#123;</span><br><span class="line">            NotificationRecord removedSummary = mSummaryByGroupKey.remove(oldGroup);</span><br><span class="line">            <span class="keyword">if</span> (removedSummary != old) &#123;</span><br><span class="line">                String removedKey =</span><br><span class="line">                        removedSummary != <span class="keyword">null</span> ? removedSummary.getKey() : <span class="string">"&lt;null&gt;"</span>;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Removed summary didn't match old notification: old="</span> + old.getKey() +</span><br><span class="line">                        <span class="string">", removed="</span> + removedKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isSummary) &#123;</span><br><span class="line">            mSummaryByGroupKey.put(group, r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Clear out group children of the old notification if the update</span></span><br><span class="line">        <span class="comment">// causes the group summary to go away. This happens when the old</span></span><br><span class="line">        <span class="comment">// notification was a summary and the new one isn't, or when the old</span></span><br><span class="line">        <span class="comment">// notification was a summary and its group key changed.</span></span><br><span class="line">        <span class="comment">//// 步骤3 </span></span><br><span class="line">        <span class="keyword">if</span> (oldIsSummary &amp;&amp; (!isSummary || !oldGroup.equals(group))) &#123;</span><br><span class="line">            cancelGroupChildrenLocked(old, callingUid, callingPid, <span class="keyword">null</span>, <span class="keyword">false</span> <span class="comment">/* sendDelete */</span>,</span><br><span class="line">                    <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤1：修正处理，当用户调用<code>Builder setGroupSummary(boolean isGroupSummary)</code>设置了<code>Notification.FLAG_GROUP_SUMMARY</code>这个flag,但是没调用 <code>Builder.setGroup(String groupKey)</code>设置对应的<code>groupKey</code>,则<code>Notification.FLAG_GROUP_SUMMARY</code>这个flag会被去掉,否则会导致后续系统的自动成组出错。这个处理纠正了一些用户的错误操作，例如用户希望发送一条父通知，但是只调用了<code>Builder setGroupSummary(boolean isGroupSummary)</code>而忘了设置相应的<code>groupKey</code>；</li>
<li>步骤2：如果必要的话更新集合<code>mSummaryByGroupKey</code>，这个集合我们前面总结过，忘记的回头看吧</li>
<li>步骤3：如果旧通知是一条父通知,新通知变成了非父通知;或者旧通知新通知均是父通知,但是<code>group key</code>已经发生了变化,则原来父通知下的所有子通知会被移除</li>
</ul>
<p>可以看到，<code>EnqueueNotificationRunnable</code>只是对通知做进一步的处理和纠偏，重点处理了<strong>通知成组相关的内容</strong>,该<code>Runnable</code>的最后是将通知发送流程进一步交给了<code>PostNotificationRunnable</code>去处理，这个<code>Runnable</code>真正做了通知在服务端的发送(post)操作。</p>
<p><strong>（4）通知Post流程</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">PostNotificationRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String key;</span><br><span class="line"></span><br><span class="line">        PostNotificationRunnable(String key) &#123;</span><br><span class="line">            <span class="keyword">this</span>.key = key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mNotificationLock) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    NotificationRecord r = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">int</span> N = mEnqueuedNotifications.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> NotificationRecord enqueued = mEnqueuedNotifications.get(i);</span><br><span class="line">                        <span class="keyword">if</span> (Objects.equals(key, enqueued.getKey())) &#123;</span><br><span class="line">                            r = enqueued;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 步骤1</span></span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        Slog.i(TAG, <span class="string">"Cannot find enqueued record for key: "</span> + key);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 步骤2</span></span><br><span class="line">                    <span class="keyword">if</span> (isBlocked(r)) &#123;</span><br><span class="line">                        Slog.i(TAG, <span class="string">"notification blocked by assistant request"</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 步骤3</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> isPackageSuspended =</span><br><span class="line">                            isPackagePausedOrSuspended(r.sbn.getPackageName(), r.getUid());</span><br><span class="line">                    r.setHidden(isPackageSuspended);</span><br><span class="line">                    <span class="keyword">if</span> (isPackageSuspended) &#123;</span><br><span class="line">                        mUsageStats.registerSuspendedByAdmin(r);</span><br><span class="line">                    &#125;</span><br><span class="line">                    NotificationRecord old = mNotificationsByKey.get(key);</span><br><span class="line">                    <span class="keyword">final</span> StatusBarNotification n = r.sbn;</span><br><span class="line">                    <span class="keyword">final</span> Notification notification = n.getNotification();</span><br><span class="line">                    <span class="keyword">int</span> index = indexOfNotificationLocked(n.getKey());</span><br><span class="line">                    <span class="comment">// 步骤4</span></span><br><span class="line">                    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        mNotificationList.add(r);</span><br><span class="line">                        mUsageStats.registerPostedByApp(r);</span><br><span class="line">                        r.setInterruptive(isVisuallyInterruptive(<span class="keyword">null</span>, r));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        old = mNotificationList.get(index);</span><br><span class="line">                        mNotificationList.set(index, r);</span><br><span class="line">                        mUsageStats.registerUpdatedByApp(r, old);</span><br><span class="line">                        <span class="comment">// Make sure we don't lose the foreground service state.</span></span><br><span class="line">                        <span class="comment">// 避免通知更新过程中前台服务标志丢失</span></span><br><span class="line">                        notification.flags |=</span><br><span class="line">                                old.getNotification().flags &amp; FLAG_FOREGROUND_SERVICE;</span><br><span class="line">                        <span class="comment">//记录通知是更新类型的,后续决定是否播放通知声音、震动等提醒的时候会用到</span></span><br><span class="line">                        r.isUpdate = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> isInterruptive = isVisuallyInterruptive(old, r);</span><br><span class="line">                        r.setTextChanged(isInterruptive);</span><br><span class="line">                        r.setInterruptive(isInterruptive);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 步骤5 记录 未排序 通知</span></span><br><span class="line">                    mNotificationsByKey.put(n.getKey(), r);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Ensure if this is a foreground service that the proper additional</span></span><br><span class="line">                    <span class="comment">// flags are set.</span></span><br><span class="line">                    <span class="comment">// 步骤6</span></span><br><span class="line">                    <span class="keyword">if</span> ((notification.flags &amp; FLAG_FOREGROUND_SERVICE) != <span class="number">0</span>) &#123;</span><br><span class="line">                        notification.flags |= FLAG_ONGOING_EVENT</span><br><span class="line">                                | FLAG_NO_CLEAR;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 步骤7</span></span><br><span class="line">                    mRankingHelper.extractSignals(r);</span><br><span class="line">                    <span class="comment">// 步骤8</span></span><br><span class="line">                    mRankingHelper.sort(mNotificationList);</span><br><span class="line">                    <span class="comment">// 步骤9</span></span><br><span class="line">                    <span class="keyword">if</span> (!r.isHidden()) &#123;</span><br><span class="line">                        buzzBeepBlinkLocked(r);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 步骤10</span></span><br><span class="line">                    <span class="keyword">if</span> (notification.getSmallIcon() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        StatusBarNotification oldSbn = (old != <span class="keyword">null</span>) ? old.sbn : <span class="keyword">null</span>;</span><br><span class="line">                        <span class="comment">// 步骤10.2</span></span><br><span class="line">                        mListeners.notifyPostedLocked(r, old);</span><br><span class="line">                        <span class="keyword">if</span> ((oldSbn == <span class="keyword">null</span> || !Objects.equals(oldSbn.getGroup(), n.getGroup()))</span><br><span class="line">                                &amp;&amp; !isCritical(r)) &#123;</span><br><span class="line">                            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    <span class="comment">// 步骤10.3</span></span><br><span class="line">                                    mGroupHelper.onNotificationPosted(</span><br><span class="line">                                            n, hasAutoGroupSummaryLocked(n));</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 步骤10.1</span></span><br><span class="line">                        Slog.e(TAG, <span class="string">"Not posting notification without small icon: "</span> + notification);</span><br><span class="line">                        <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; !old.isCanceled) &#123;</span><br><span class="line">                            mListeners.notifyRemovedLocked(r,</span><br><span class="line">                                    NotificationListenerService.REASON_ERROR, r.getStats());</span><br><span class="line">                            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    mGroupHelper.onNotificationRemoved(n);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// ATTENTION: in a future release we will bail out here</span></span><br><span class="line">                        <span class="comment">// so that we do not play sounds, show lights, etc. for invalid</span></span><br><span class="line">                        <span class="comment">// notifications</span></span><br><span class="line">                        Slog.e(TAG, <span class="string">"WARNING: In a future release this will crash the app: "</span></span><br><span class="line">                                + n.getPackageName());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    maybeRecordInterruptionLocked(r);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// 将前面入列的通知从 mEnqueuedNotifications 移除，</span></span><br><span class="line">                    <span class="comment">// 所以最终该集合记录的是所有入列成功但发送不成功的通知</span></span><br><span class="line">                    <span class="keyword">int</span> N = mEnqueuedNotifications.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> NotificationRecord enqueued = mEnqueuedNotifications.get(i);</span><br><span class="line">                        <span class="keyword">if</span> (Objects.equals(key, enqueued.getKey())) &#123;</span><br><span class="line">                            mEnqueuedNotifications.remove(i);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤1 </span></span><br><span class="line"><span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123; <span class="keyword">return</span>; &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤1：若通知已入列但是没走到这里的时候就被取消了，则停止发送处理，因为存在通知处理一半就被取消的情况，而取消通知时会从<code>mEnqueuedNotifications</code>将通知移除，所以将入列期间的通知存在<code>mEnqueuedNotifications</code>中可以让我们在处理通知的不同阶段去检查通知是否已经被移除</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤2</span></span><br><span class="line"><span class="keyword">if</span> (isBlocked(r)) &#123; <span class="keyword">return</span>; &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤2：前面 <code>enqueueNotificationInternal</code> 已经做过一次 blocked 检查,这里再次检查是避免在中间处理过程中 blocked 属性发生了改变，所以整个通知发送过程中存在两次 blocked 状态检查</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤3：</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> isPackageSuspended = isPackagePausedOrSuspended(r.sbn.getPackageName(), r.getUid());</span><br><span class="line">r.setHidden(isPackageSuspended);</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤3：该应用是否被系统限制了,是的话hidden为true,这个属性在后面决定是否播放通知声音、震动等提醒的时候会用到</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NotificationRecord old = mNotificationsByKey.get(key);</span><br><span class="line"><span class="keyword">final</span> StatusBarNotification n = r.sbn;</span><br><span class="line"><span class="keyword">final</span> Notification notification = n.getNotification();</span><br><span class="line"><span class="keyword">int</span> index = indexOfNotificationLocked(n.getKey());</span><br><span class="line"><span class="comment">// 步骤4</span></span><br><span class="line"><span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    mNotificationList.add(r);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    old = mNotificationList.get(index);</span><br><span class="line">    mNotificationList.set(index, r);</span><br><span class="line">    <span class="comment">// 避免通知更新过程中前台服务标志丢失</span></span><br><span class="line">    notification.flags |=</span><br><span class="line">    old.getNotification().flags &amp; FLAG_FOREGROUND_SERVICE;</span><br><span class="line">    <span class="comment">// 记录通知是更新类型的,后续决定是否播放通知声音、震动等提醒的时候会用到</span></span><br><span class="line">    r.isUpdate = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤4：前面总结过，<code>mNotificationList</code>是存储 已排序 的通知，这里判断新来的通知是不是更新类型的，不是的话就直接add进<code>mNotificationList</code>，是的话则会将旧的通知替换掉，排序不变</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤5 记录 未排序 通知</span></span><br><span class="line">mNotificationsByKey.put(n.getKey(), r);</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤5：将即将发送的通知存进集合<code>mNotificationsByKey</code>，这也是为什么前面我们可以通过<code>mNotificationsByKey</code>获取到某通知是否存在旧通知的原因</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤6</span></span><br><span class="line"><span class="keyword">if</span> ((notification.flags &amp; FLAG_FOREGROUND_SERVICE) != <span class="number">0</span>) &#123; </span><br><span class="line">    notification.flags |= FLAG_ONGOING_EVENT | FLAG_NO_CLEAR; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤6：<strong>前台服务通知是强制常驻通知面板的</strong>，不管你发送的时候是否设置了相关的常驻标志（<code>FLAG_ONGOING_EVENT / FLAG_NO_CLEAR</code>），系统都会帮你加上</li>
</ul>
<p><strong>通知排序预处理:</strong></p>
<p>这一步是在<strong>对通知进行排序前利用各种规则更新通知的各种属性</strong>， 这里涉及到几个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/services/core/java/com/android/server/notification/RankingConfig.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/notification/PreferencesHelper.java</span><br><span class="line"></span><br><span class="line">frameworks/base/services/core/java/com/android/server/notification/NotificationChannelExtractor.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/notification/BadgeExtractor.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/notification/ZenModeExtractor.java</span><br><span class="line">frameworks/base/services/core/java/com/android/server/notification/XXXExtractor.java</span><br></pre></td></tr></table></figure>

<p><code>RankingConfig</code>，接口类，定义了各种通知属性的操作接口，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RankingConfig</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setImportance</span><span class="params">(String packageName, <span class="keyword">int</span> uid, <span class="keyword">int</span> importance)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getImportance</span><span class="params">(String packageName, <span class="keyword">int</span> uid)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setShowBadge</span><span class="params">(String packageName, <span class="keyword">int</span> uid, <span class="keyword">boolean</span> showBadge)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">createNotificationChannel</span><span class="params">(String pkg, <span class="keyword">int</span> uid, NotificationChannel channel,<span class="keyword">boolean</span> fromTargetApp, <span class="keyword">boolean</span> hasDndAccess)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateNotificationChannel</span><span class="params">(String pkg, <span class="keyword">int</span> uid, NotificationChannel channel, <span class="keyword">boolean</span> fromUser)</span></span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而接口的实现类为<code>PreferencesHelper</code>，我们挑两个来看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/PreferencesHelper.java*/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canShowBadge</span><span class="params">(String packageName, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackagePreferences) &#123;</span><br><span class="line">            <span class="keyword">return</span> getOrCreatePackagePreferencesLocked(packageName, uid).showBadge;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setShowBadge</span><span class="params">(String packageName, <span class="keyword">int</span> uid, <span class="keyword">boolean</span> showBadge)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mPackagePreferences) &#123;</span><br><span class="line">            getOrCreatePackagePreferencesLocked(packageName, uid).showBadge = showBadge;</span><br><span class="line">        &#125;</span><br><span class="line">        updateConfig();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>badge</code>表示通知圆点，也就是应用桌面图标右上角上那个 告诉你该应用来通知了的小圆点，当我们在设置中设置某应用的圆点开关的时候，请求会被从 <strong>设置 跨应用发送到 NMS</strong>，NMS则调用 <code>PreferencesHelper.setShowBadge(String packageName, int uid, boolean showBadge)</code>来执行该更新事件，更新结果保存在<code>PreferencesHelper</code>中一个叫<code>PackagePreferences</code>的数据结构中，并在更新完成的时候调用<code>updateConfig</code>去更新配置，以便我们后续使用<code>RankingConfig</code>时能读到最新的状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/PreferencesHelper$PackagePreferences.java*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackagePreferences</span> </span>&#123;</span><br><span class="line">        String pkg; <span class="comment">// 包名</span></span><br><span class="line">        <span class="keyword">int</span> uid = UNKNOWN_UID;</span><br><span class="line">        <span class="keyword">int</span> importance = DEFAULT_IMPORTANCE; <span class="comment">// 通知重要程度</span></span><br><span class="line">        <span class="keyword">int</span> priority = DEFAULT_PRIORITY; <span class="comment">// 通知优先级</span></span><br><span class="line">        <span class="keyword">int</span> visibility = DEFAULT_VISIBILITY; <span class="comment">// 通知可见性</span></span><br><span class="line">        <span class="keyword">boolean</span> showBadge = DEFAULT_SHOW_BADGE; <span class="comment">// 通知圆点</span></span><br><span class="line">        <span class="keyword">boolean</span> allowBubble = DEFAULT_ALLOW_BUBBLE; <span class="comment">// 气泡通知</span></span><br><span class="line">        <span class="keyword">int</span> lockedAppFields = DEFAULT_LOCKED_APP_FIELDS;</span><br><span class="line">        <span class="keyword">boolean</span> oemLockedImportance = DEFAULT_OEM_LOCKED_IMPORTANCE;</span><br><span class="line">        List&lt;String&gt; futureOemLockedChannels = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">boolean</span> defaultAppLockedImportance = DEFAULT_APP_LOCKED_IMPORTANCE;</span><br><span class="line">        Delegate delegate = <span class="keyword">null</span>;</span><br><span class="line">        ArrayMap&lt;String, NotificationChannel&gt; channels = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">        Map&lt;String, NotificationChannelGroup&gt; groups = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValidDelegate</span><span class="params">(String pkg, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> delegate != <span class="keyword">null</span> &amp;&amp; delegate.isAllowed(pkg, uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>NotificationChannelExtractor</code>，规则处理器抽象类，定义各种规则的抽象接口，具体规则则由各种类型的子类去实现，后面会举例，先看看这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NotificationSignalExtractor</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化接口</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Context context, NotificationUsageStats usageStats)</span></span>;</span><br><span class="line">    <span class="comment">// 每次通知发送或更新的时候调用,如果`process`方法处理完之后还有其他东西需要做进一步处理,则返回一个`RankingReconsideration`</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RankingReconsideration <span class="title">process</span><span class="params">(NotificationRecord notification)</span></span>;</span><br><span class="line">    <span class="comment">// 让规则处理器持有规则`RankingConfig`</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setConfig</span><span class="params">(RankingConfig config)</span></span>;</span><br><span class="line">    <span class="comment">// 让规则处理器持有免打扰辅助类`ZenModeHelper`</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setZenHelper</span><span class="params">(ZenModeHelper helper)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该接口有多个实现类，一套规则一个实现类，我们挑一个来看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BadgeExtractor</span> <span class="keyword">implements</span> <span class="title">NotificationSignalExtractor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> RankingConfig mConfig;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(Context ctx, NotificationUsageStats usageStats)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> RankingReconsideration <span class="title">process</span><span class="params">(NotificationRecord record)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (record == <span class="keyword">null</span> || record.getNotification() == <span class="keyword">null</span>) &#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line">        <span class="keyword">if</span> (mConfig == <span class="keyword">null</span>) &#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line">        <span class="keyword">boolean</span> userWantsBadges = mConfig.badgingEnabled(record.sbn.getUser());</span><br><span class="line">        <span class="keyword">boolean</span> appCanShowBadge = mConfig.canShowBadge(record.sbn.getPackageName(), record.sbn.getUid());</span><br><span class="line">        <span class="keyword">if</span> (!userWantsBadges || !appCanShowBadge) &#123;</span><br><span class="line">            record.setShowBadge(<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (record.getChannel() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                record.setShowBadge(record.getChannel().canShowBadge() &amp;&amp; appCanShowBadge);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                record.setShowBadge(appCanShowBadge);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (record.isIntercepted()</span><br><span class="line">                &amp;&amp; (record.getSuppressedVisualEffects() &amp; SUPPRESSED_EFFECT_BADGE) != <span class="number">0</span>) &#123;</span><br><span class="line">            record.setShowBadge(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfig</span><span class="params">(RankingConfig config)</span> </span>&#123;</span><br><span class="line">        mConfig = config;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setZenHelper</span><span class="params">(ZenModeHelper helper)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一套决定通知是否显示圆点的规则，规则包括：</p>
<ul>
<li>系统是否允许显示圆点(Config.badgingEnabled)，受一个系统全局变量影响，该变量写在 Settings 数据库字段中：NOTIFICATION_BADGING = “notification_badging”，改变该值的地方是 设置中的开关</li>
<li>用户是否在设置中打开了允许通知(Config.canShowBadge)，受我们前面说的<code>setShowBadge</code>接口影响，也就是会去查询<code>PreferencesHelper</code>类中的数据结构<code>PackagePreferences</code></li>
<li>此外还可能受通知<code>channel</code>影响等等</li>
</ul>
<p>以上只是处理了一个通知属性，而其他各种属性则分别在不同的规则处理器中处理，Android定义了一个配置列表，声明了所有的规则处理器，同时允许我们去扩展我们自己的规则处理器。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">/*frameworks/base/core/res/res/values/config.xml*/</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">string-array</span> <span class="attr">name</span>=<span class="string">"config_notificationSignalExtractors"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- many of the following extractors depend on the notification channel, so this</span></span><br><span class="line"><span class="comment">extractor must come first --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.NotificationChannelExtractor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.NotificationAdjustmentExtractor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.BubbleExtractor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- depends on AdjustmentExtractor--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.ValidateNotificationPeople<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.PriorityExtractor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- depends on PriorityExtractor --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.ZenModeExtractor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.ImportanceExtractor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- depends on ImportanceExtractor--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.NotificationIntrusivenessExtractor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.VisibilityExtractor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Depends on ZenModeExtractor --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.BadgeExtractor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span>&gt;</span>com.android.server.notification.CriticalNotificationExtractor<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">string-array</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当我们需要新增规则时，只需要在这个配置列表中指定我们的规则实现类，并让我们的规则实现类实现<code>NotificationSignalExtractor</code>这个接口，完成我们特定的规则制定即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤7</span></span><br><span class="line">mRankingHelper.extractSignals(r);</span><br></pre></td></tr></table></figure>

<p>我们接着看<code>PostNotificationRunnable.run()</code>中的步骤7</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/RankingHelper.java*/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">extractSignals</span><span class="params">(NotificationRecord r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mSignalExtractors.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            NotificationSignalExtractor extractor = mSignalExtractors[i];</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                RankingReconsideration recon = extractor.process(r);</span><br><span class="line">                <span class="keyword">if</span> (recon != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mRankingHandler.requestReconsideration(recon);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>也就是遍历各个规则处理器，触发其<code>process</code>方法去设置通知的各种属性，当返回值<code>RankingReconsideration</code>不为空时，则进一步处理其他规则，不展开讲。</p>
<p>这里主要学习源码的这种实现思路：<strong>将赋值过程复杂的属性的处理通过抽象隔离开来分别处理，达到修改某个属性的规则时不影响其他属性的目的，同时还保证了良好的可扩展性，当我们需要定义新的规则的时候，只需要扩展我们自己的一套规则即可</strong>.</p>
<p>这里体现了设计模式中多个基本原则，如<strong>单一职责原则（一个类应只包含单一的职责）、依赖倒转原则（抽象不应该依赖于细节，细节应当依赖于抽象）和迪米特原则（一个类尽量不要与其他类发生关系）等</strong>，整个通知系统的设计是十分复杂的，这个过程中有很多设计模式的体现，读者阅读的时候可多加思考并学习其应用。</p>
<p><strong>通知排序:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤8</span></span><br><span class="line">mRankingHelper.sort(mNotificationList);</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤8：更新完通知的各种属性后，就可以对通知进行排序了，可以看到传进去排序的集合为<code>mNotificationList</code>，这也就是为什么我们前面说<code>mNotificationList</code>是已排序的通知集合</li>
</ul>
<p>服务端通知排序分为两次，初步排序与最终排序，具体排序规则受两个排序类影响：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">初步排序：frameworks/base/services/core/java/com/android/server/notification/NotificationComparator.java</span><br><span class="line">最终排序：frameworks/base/services/core/java/com/android/server/notification/GlobalSortKeyComparator.java</span><br></pre></td></tr></table></figure>

<p>其中初步排序主要是 <strong>根据Importance / 彩色通知(受Notification.setColorized()接口影响) / 是否常驻通知(ongoing) / 是否重要消息 / 是否重要联系人 / priority / 通知发送时间</strong> 等因素影响，其中通知发送时间在排序规则中是最后被考虑的，这也是为什么经常我们看到的最新通知不一定是显示在最顶端的原因。具体规则和代码不展开讲，感兴趣的自己阅读下<code>frameworks/base/services/core/java/com/android/server/notification/NotificationComparator.java</code> 的 <code>compare</code> 方法。</p>
<p>对于初步排序这里只强调一点，由于<code>Comparator</code>比较器默认是升序的，如果不做处理会导致<code>mNotificationList</code>中的通知的排序是按照重要程度从低到高排序，这与我们的预期结果是相反的，源码的处理是在返回比较结果前做一次反序处理，举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/NotificationComparator.java*/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(NotificationRecord left, NotificationRecord right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> leftImportance = left.getImportance();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> rightImportance = right.getImportance();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isLeftHighImportance = leftImportance &gt;= IMPORTANCE_DEFAULT;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isRightHighImportance = rightImportance &gt;= IMPORTANCE_DEFAULT;</span><br><span class="line">        <span class="keyword">if</span> (Settings.Secure.getInt(mContext.getContentResolver(),</span><br><span class="line">                Settings.Secure.NOTIFICATION_NEW_INTERRUPTION_MODEL, <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isLeftHighImportance != isRightHighImportance) &#123;</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span> * Boolean.compare(isLeftHighImportance, isRightHighImportance);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们知道，<code>int compare(T o1, T o2)</code>是“比较o1和o2的大小”：</p>
<ul>
<li>返回 负数 表示 <strong>o1 比 o2小</strong></li>
<li>返回 0 表示 <strong>o1 等于 o2</strong></li>
<li>返回 正数 表示 <strong>o1 大于 o2</strong></li>
</ul>
<p>所以正常情况下，当<code>isLeftHighImportance</code>的值大于<code>isRightHighImportance</code>时，由于是升序，<code>Importance</code>较大的通知会被排在后面，而这里执行了 <code>-1 * result</code> 后，<code>Importance</code>较大的通知就排在前面了。</p>
<p><strong>接下来思考：为什么初步排序还不够呢</strong>，这里就涉及到我们发送通知时可能会用到的一个接口了：<code>Builder.setSortKey()</code>，有时候我们发送通知会调用<code>Builder.setSortKey()</code>设置一个排序键值，去对当前应用的通知进行排序，系统就是在最终排序里面对我们通过<code>setSortKey</code>设置的排序规则做受理的，而在最终排序前，系统会去规范我们设置的键值</p>
<p>那当我们设置了<code>setSortKey</code>之后，系统是怎么排序的呢？下面看看步骤8的<code>sort</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/RankingHelper.java*/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(ArrayList&lt;NotificationRecord&gt; notificationList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = notificationList.size();</span><br><span class="line">        <span class="comment">// clear global sort keys</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = N - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            notificationList.get(i).setGlobalSortKey(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初步排序，详见 `NotificationComparator`</span></span><br><span class="line">        Collections.sort(notificationList, mPreliminaryComparator);</span><br><span class="line">        <span class="comment">// 最终排序前的预处理</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mProxyByGroupTmp) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> NotificationRecord record = notificationList.get(i);</span><br><span class="line">                record.setAuthoritativeRank(i);</span><br><span class="line">                <span class="keyword">final</span> String groupKey = record.getGroupKey();</span><br><span class="line">                NotificationRecord existingProxy = mProxyByGroupTmp.get(groupKey);</span><br><span class="line">                <span class="keyword">if</span> (existingProxy == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mProxyByGroupTmp.put(groupKey, record);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> NotificationRecord record = notificationList.get(i);</span><br><span class="line">                NotificationRecord groupProxy = mProxyByGroupTmp.get(record.getGroupKey());</span><br><span class="line">                String groupSortKey = record.getNotification().getSortKey();</span><br><span class="line">                <span class="comment">// 步骤8.1，执行预处理</span></span><br><span class="line">                String groupSortKeyPortion;</span><br><span class="line">                <span class="keyword">if</span> (groupSortKey == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    groupSortKeyPortion = <span class="string">"nsk"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (groupSortKey.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">                    groupSortKeyPortion = <span class="string">"esk"</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    groupSortKeyPortion = <span class="string">"gsk="</span> + groupSortKey;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">boolean</span> isGroupSummary = record.getNotification().isGroupSummary();</span><br><span class="line">                <span class="comment">// 步骤8.2，执行预处理</span></span><br><span class="line">               record.setGlobalSortKey(String.format(<span class="string">"crtcl=0x%04x:intrsv=%c:grnk=0x%04x:gsmry=%c:%s:rnk=0x%04x"</span>,</span><br><span class="line">                        record.getCriticality(), record.isRecentlyIntrusive() &amp;&amp; record.getImportance() &gt; NotificationManager.IMPORTANCE_MIN ? <span class="string">'0'</span> : <span class="string">'1'</span>,</span><br><span class="line">                        groupProxy.getAuthoritativeRank(), isGroupSummary ? <span class="string">'0'</span> : <span class="string">'1'</span>, groupSortKeyPortion, record.getAuthoritativeRank()));</span><br><span class="line">            &#125;</span><br><span class="line">            mProxyByGroupTmp.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 步骤8.3，执行最终排序</span></span><br><span class="line">        Collections.sort(notificationList, mFinalComparator);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤8.1：最终排序预处理，可以看到系统对<code>sortKey</code>做了统一处理：<ul>
<li>当我们没设置<code>sortKey</code>时，groupSortKeyPortion = “nsk”</li>
<li>当我们设置的<code>sortKey</code>为空(也就是””)时，groupSortKeyPortion = “esk”;</li>
<li>当我们设置的<code>sortKey</code>不为null时，groupSortKeyPortion = “gsk=” + groupSortKey;</li>
</ul>
</li>
<li>步骤8.2：最终排序预处理，以<code>crtcl=0x%04x:intrsv=%c:grnk=0x%04x:gsmry=%c:%s:rnk=0x%04x</code>这个格式为<code>record</code>设置<code>mGlobalSortKey</code>，也就是系统将这几个属性组合成一个字符串，赋值给<code>mGlobalSortKey</code>，里面就包括前面步骤1中规范化出来的<code>sortKey</code>，而这一整个字符串将在最终排序中影响通知排序</li>
<li>步骤8.3：执行最终排序，这里我们直接看最终排序用的这个对比器<code>mFinalComparator</code>里面的规则：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/GlobalSortKeyComparator.java*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalSortKeyComparator</span> <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">NotificationRecord</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(NotificationRecord left, NotificationRecord right)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (left.getGlobalSortKey() == <span class="keyword">null</span>) &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">if</span> (right.getGlobalSortKey() == <span class="keyword">null</span>) &#123; <span class="keyword">return</span>  -<span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> left.getGlobalSortKey().compareTo(right.getGlobalSortKey());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到系统直接比较了前面设置的<code>mGlobalSortKey</code>值，<code>mGlobalSortKey</code>是一个字符串，也就是这里的排序规则是由<strong>字典序</strong>排序规则决定的。结合前面两点我们可以得出，当两条通知的<code>crtcl、intrsv、grnk、gsmry</code>这几个属性的值都一样的情况下，我们通过<code>Builder.setSortKey()</code>设置的排序键值就会生效了。</p>
<p>经过前面系统的规范，不同的键值类型对应的字典序排序结果为：<strong>esk类型 &gt; gsk=xxx类型 &gt; nsk类型</strong>，即<code>sortKey</code>类型为<strong>“”</strong> 的通知会排在最前面，接着是设置了<code>sortKey</code>的通知，这一类通知的排序则根据用户指定的<code>sortKey</code>而定，接着才是没设置<code>sortKey</code>的，本地写了个demo验证了下，结果如下：</p>
<img src="http://wxyy97.com/image/notification_sortdemo.jpg" style="zoom:50%;" />

<p>到这里我们也就明白了为什么有时候设置<code>sortKey</code>并不能生效了，因为<code>sortKey</code>的排序优先级不是最高的，还受<code>crtcl、intrsv、grnk、gsmry</code>这几个属性影响。</p>
<p><strong>通知震动、音效和呼吸灯处理:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤9</span></span><br><span class="line"><span class="keyword">if</span> (!r.isHidden()) &#123; buzzBeepBlinkLocked(r); &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤9：这里开始处理通知的<strong>震动、音效和呼吸灯</strong>效果，这里主要根据通知的 重要程度、是否当前用户、是否更新类型的通知等 信息共同决定当前这条通知是否需要 震动、音效和呼吸灯效果，代码较简单，不展开讲，感兴趣的童鞋直接看下<code>NotificationManagerService.buzzBeepBlinkLocked(NotificationRecord record)</code>方法，下面重点看看通知的post。</li>
</ul>
<p><strong>通知Post:</strong></p>
<p>分析了这么久，我们终于来到通知的发送步骤了，别急，还有很多事情没处理呢～例如我们前面说过，当用户未主动给应用通知设置组别时，系统会帮我们最这件事，但是到目前为止都没有见到相关处理，答案就在下面，接着往下看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*PostNotificationRunnable.run()*/</span></span><br><span class="line">                    <span class="comment">// 步骤:10</span></span><br><span class="line">                    <span class="keyword">if</span> (notification.getSmallIcon() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        StatusBarNotification oldSbn = (old != <span class="keyword">null</span>) ? old.sbn : <span class="keyword">null</span>;</span><br><span class="line">                        <span class="comment">// 步骤10.2</span></span><br><span class="line">                        mListeners.notifyPostedLocked(r, old);</span><br><span class="line">                        <span class="keyword">if</span> ((oldSbn == <span class="keyword">null</span> || !Objects.equals(oldSbn.getGroup(), n.getGroup())) &amp;&amp; !isCritical(r)) &#123;</span><br><span class="line">                            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    <span class="comment">// 步骤10.3</span></span><br><span class="line">                                    mGroupHelper.onNotificationPosted(n, hasAutoGroupSummaryLocked(n)); </span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 步骤10.1</span></span><br><span class="line">                        <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; !old.isCanceled) &#123;</span><br><span class="line">                            mListeners.notifyRemovedLocked(r, NotificationListenerService.REASON_ERROR, r.getStats());</span><br><span class="line">                            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    mGroupHelper.onNotificationRemoved(n);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// 将前面入列的通知从 mEnqueuedNotifications 移除，所以最终该集合记录的是所有入列成功但发送不成功的通知</span></span><br><span class="line">                    <span class="keyword">int</span> N = mEnqueuedNotifications.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> NotificationRecord enqueued = mEnqueuedNotifications.get(i);</span><br><span class="line">                        <span class="keyword">if</span> (Objects.equals(key, enqueued.getKey())) &#123;</span><br><span class="line">                            mEnqueuedNotifications.remove(i);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤10：这里再次对通知是否有<code>mSmallIcon</code>做了检查，避免前面在处理通知的过程中<code>mSmallIcon</code>丢失了，而没有<code>mSmallIcon</code>的通知是一定不能发送的，这也看出了Google对流氓通知是零容忍的。如果没有<code>mSmallIcon</code>，则走进<code>else</code>。</li>
<li>步骤10.1：先看<code>else</code> 的情况，此时如果旧通知已成功发送但新通知没<code>smallIcon</code>，则旧通知会被移除，所以移除通知不一定要调用<code>cancel</code>接口，在这种情况下旧通知也是会被移除的。</li>
</ul>
<p><strong>通知各监听者:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*PostNotificationRunnable.run()*/</span></span><br><span class="line"><span class="comment">// 步骤10.2</span></span><br><span class="line">mListeners.notifyPostedLocked(r, old);</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤10.2：<code>mSmallIcon</code>不为空，终于可以发送了，<code>mListeners.notifyPostedLocked(r, old)</code>将以异步的形式，将该消息通知给各个<code>listeners</code>，其中就包括我们后面主要分析的<code>SystemUI</code>:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/NotificationManagerService.java$*/</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyPostedLocked</span><span class="params">(NotificationRecord r, NotificationRecord old, <span class="keyword">boolean</span> notifyAllListeners)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> ManagedServiceInfo info : getServices()) &#123;</span><br><span class="line">                <span class="comment">// 过滤掉部分listener.如不可见用户,Android P以下hidden类型的通知等</span></span><br><span class="line">                ......</span><br><span class="line">                <span class="comment">// 步骤10.2.1</span></span><br><span class="line">                <span class="keyword">final</span> NotificationRankingUpdate update = makeRankingUpdateLocked(info);</span><br><span class="line">                <span class="comment">// 移除原来可见现在不可见的通知</span></span><br><span class="line">                <span class="keyword">if</span> (oldSbnVisible &amp;&amp; !sbnVisible) &#123;</span><br><span class="line">                    <span class="keyword">final</span> StatusBarNotification oldSbnLightClone = oldSbn.cloneLight();</span><br><span class="line">                    mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            notifyRemoved(</span><br><span class="line">                                    info, oldSbnLightClone, update, <span class="keyword">null</span>, REASON_USER_STOPPED);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 步骤10.2.2</span></span><br><span class="line">                mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        notifyPosted(info, sbnToPost, update);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤10.2.1：<strong>构建一个包含所有通知排序信息和关键属性的映射表，其中<code>key=StatusBarNotification.key，value=NotificationListenerService.Ranking</code></strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/NotificationManagerService.java$*/</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> NotificationRankingUpdate <span class="title">makeRankingUpdateLocked</span><span class="params">(ManagedServiceInfo info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mNotificationList.size();</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;NotificationListenerService.Ranking&gt; rankings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            NotificationRecord record = mNotificationList.get(i);</span><br><span class="line">            <span class="comment">// 过滤掉当前用户不可见的通知</span></span><br><span class="line">            <span class="keyword">if</span> (!isVisibleToListener(record.sbn, info)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> String key = record.sbn.getKey();</span><br><span class="line">            <span class="comment">// 一条通知对应一个 Ranking</span></span><br><span class="line">            <span class="keyword">final</span> NotificationListenerService.Ranking ranking =</span><br><span class="line">                    <span class="keyword">new</span> NotificationListenerService.Ranking();</span><br><span class="line">            <span class="comment">// 将通知的关键信息，包括排序、关键属性等存进 Ranking</span></span><br><span class="line">            ranking.populate(</span><br><span class="line">                    key,</span><br><span class="line">                    rankings.size(),</span><br><span class="line">                    !record.isIntercepted(),</span><br><span class="line">                    record.getPackageVisibilityOverride(),</span><br><span class="line">                    record.getSuppressedVisualEffects(),</span><br><span class="line">                    record.getImportance(),</span><br><span class="line">                    record.getImportanceExplanation(),</span><br><span class="line">                    record.sbn.getOverrideGroupKey(),</span><br><span class="line">                    record.getChannel(),</span><br><span class="line">                    record.getPeopleOverride(),</span><br><span class="line">                    record.getSnoozeCriteria(),</span><br><span class="line">                    record.canShowBadge(),</span><br><span class="line">                    record.getUserSentiment(),</span><br><span class="line">                    record.isHidden(),</span><br><span class="line">                    record.getLastAudiblyAlertedMs(),</span><br><span class="line">                    record.getSound() != <span class="keyword">null</span> || record.getVibration() != <span class="keyword">null</span>,</span><br><span class="line">                    record.getSystemGeneratedSmartActions(),</span><br><span class="line">                    record.getSmartReplies(),</span><br><span class="line">                    record.canBubble()</span><br><span class="line">            );</span><br><span class="line">            rankings.add(ranking);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 构建`RankingMap`</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NotificationRankingUpdate(</span><br><span class="line">                rankings.toArray(<span class="keyword">new</span> NotificationListenerService.Ranking[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>关注下最后一步：将列表转为 <code>NotificationListenerService.Ranking</code> 类型的数组，然后构建一个<code>RankingMap</code>，<code>RankingMap</code>是一个<code>key=StatusBarNotification.key，value=NotificationListenerService.Ranking</code>的<code>ArrayMap</code>，后面<code>SystemUI</code>会根据这个映射表的排序信息显示通知。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/core/java/android/service/notification/NotificationRankingUpdate.java*/</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NotificationRankingUpdate</span><span class="params">(NotificationListenerService.Ranking[] rankings)</span> </span>&#123;</span><br><span class="line">        mRankingMap = <span class="keyword">new</span> NotificationListenerService.RankingMap(rankings);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*frameworks/base/core/java/android/service/notification/NotificationRankingUpdate$RankingMap.java*/</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">RankingMap</span><span class="params">(Ranking[] rankings)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rankings.length; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> String key = rankings[i].getKey();</span><br><span class="line">                mOrderedKeys.add(key);</span><br><span class="line">                <span class="comment">// key=StatusBarNotification.key，value=NotificationListenerService.Ranking</span></span><br><span class="line">                mRankings.put(key, rankings[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤10.2.2：执行<code>listener.onNotificationPosted(sbnHolder, rankingUpdate);</code>接口通知各个监听器</li>
</ul>
<p>至此，各个监听器就能收到来新通知的消息了。</p>
<p><strong>尝试构建系统分组:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*PostNotificationRunnable.run()*/</span></span><br><span class="line"><span class="keyword">if</span> ((oldSbn == <span class="keyword">null</span> || !Objects.equals(oldSbn.getGroup(), n.getGroup())) &amp;&amp; !isCritical(r)) &#123;</span><br><span class="line">    mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 步骤10.3</span></span><br><span class="line">            mGroupHelper.onNotificationPosted(n, hasAutoGroupSummaryLocked(n)); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤10.3：这里将利用分组通知的辅助类<code>GroupHelper</code>在必要的情况下构建一个父通知，前面我们说的用户未主动将通知分组时系统会帮我们去做这件事，就是在这里完成的。但<code>GroupHelper</code>只是负责判断是否需要创建或者移除系统创建的通知，具体的操作是在NMS中完成的，涉及到下面这个回调：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/GroupHelper.java*/</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">addAutoGroup</span><span class="params">(String key)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">removeAutoGroup</span><span class="params">(String key)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">addAutoGroupSummary</span><span class="params">(<span class="keyword">int</span> userId, String pkg, String triggeringKey)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">removeAutoGroupSummary</span><span class="params">(<span class="keyword">int</span> user, String pkg)</span></span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>NMS将回调注册到<code>GroupHelper</code>，<code>GroupHelper</code>则在必要的时候通知NMS去完成相关操作，来看看 步骤10.3 的具体操作，代码做过简化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/GroupHelper.java*/</span></span><br><span class="line">    <span class="comment">// 步骤10.3.1</span></span><br><span class="line">    Map&lt;Integer, Map&lt;String, LinkedHashSet&lt;String&gt;&gt;&gt; mUngroupedNotifications = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationPosted</span><span class="params">(StatusBarNotification sbn, <span class="keyword">boolean</span> autogroupSummaryExists)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;String&gt; notificationsToGroup = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="comment">// 步骤10.3.2</span></span><br><span class="line">            <span class="keyword">if</span> (!sbn.isAppGroup()) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (mUngroupedNotifications) &#123;</span><br><span class="line">                    <span class="comment">// 步骤10.3.3</span></span><br><span class="line">                    <span class="keyword">if</span> (notificationsForPackage.size() &gt;= mAutoGroupAtCount</span><br><span class="line">                            || autogroupSummaryExists) &#123;</span><br><span class="line">                        notificationsToGroup.addAll(notificationsForPackage);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (notificationsToGroup.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 步骤10.3.4</span></span><br><span class="line">                    adjustAutogroupingSummary(sbn.getUserId(), sbn.getPackageName(), notificationsToGroup.get(<span class="number">0</span>), <span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 步骤10.3.5</span></span><br><span class="line">                    adjustNotificationBundling(notificationsToGroup, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 步骤10.3.6</span></span><br><span class="line">                maybeUngroup(sbn, <span class="keyword">false</span>, sbn.getUserId());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤10.3.1：<code>GroupHelper</code>持有一个集合<code>mUngroupedNotifications</code>，存储内容为：&lt;user, &lt;packageName, notificationsForPackage&gt;&gt;，这样就能将每个用户的每个应用下的通知存储起来，在条件满足的时候去执行系统成组操作</li>
<li>步骤10.3.2：若用户创建该通知的时候未指定<code>mGroupKey</code>或者<code>mSortKey</code>，则系统会尝试去走创建父通知的逻辑</li>
<li>步骤10.3.3：系统尝试创建父通知，创建的条件是<strong>该应用的通知数达到了4条 或者 之前已经存在该应用的父通知了</strong>，这个的 <strong>4</strong> 是在配置在<code>config</code>中的，路径为<code>frameworks/base/core/res/res/values/config.xml 下的 config_autoGroupAtCount</code>字段，所以如果我们想要修改系统的通知自动成组数条件，修改该变量即可。</li>
<li>步骤10.3.4：满足创建父通知的条件，走<code>adjustAutogroupingSummary</code>逻辑，该方法最终调了NMS中的<code>addAutoGroupSummary</code>方法，这里关注下创建的这条父通知的内容：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*frameworks/base/services/core/java/com/android/server/notification/NotificationManagerService.java*/</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createAutoGroupSummary</span><span class="params">(<span class="keyword">int</span> userId, String pkg, String triggeringKey)</span> </span>&#123;</span><br><span class="line">        NotificationRecord summaryRecord = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mNotificationLock) &#123;</span><br><span class="line">            <span class="comment">// 步骤10.3.4.1</span></span><br><span class="line">            NotificationRecord notificationRecord = mNotificationsByKey.get(triggeringKey);</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (!summaries.containsKey(pkg)) &#123;</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">final</span> Notification summaryNotification =</span><br><span class="line">                        <span class="keyword">new</span> Notification.Builder(getContext(), channelId)</span><br><span class="line">                                .setSmallIcon(adjustedSbn.getNotification().getSmallIcon())</span><br><span class="line">                                .setGroupSummary(<span class="keyword">true</span>)</span><br><span class="line">                                .setGroupAlertBehavior(Notification.GROUP_ALERT_CHILDREN)</span><br><span class="line">                                <span class="comment">// 步骤10.3.4.2</span></span><br><span class="line">                                .setGroup(GroupHelper.AUTOGROUP_KEY)</span><br><span class="line">                                .setFlag(FLAG_AUTOGROUP_SUMMARY, <span class="keyword">true</span>)</span><br><span class="line">                                .setFlag(Notification.FLAG_GROUP_SUMMARY, <span class="keyword">true</span>)</span><br><span class="line">                                .setColor(adjustedSbn.getNotification().color)</span><br><span class="line">                                .setLocalOnly(<span class="keyword">true</span>)</span><br><span class="line">                                .build();</span><br><span class="line">                ......</span><br><span class="line">                <span class="keyword">final</span> StatusBarNotification summarySbn =</span><br><span class="line">                        <span class="keyword">new</span> StatusBarNotification(adjustedSbn.getPackageName(), adjustedSbn.getOpPkg(), Integer.MAX_VALUE,</span><br><span class="line">                                <span class="comment">// 步骤10.3.4.2</span></span><br><span class="line">                                GroupHelper.AUTOGROUP_KEY, </span><br><span class="line">                                adjustedSbn.getUid(), adjustedSbn.getInitialPid(), summaryNotification, adjustedSbn.getUser(),</span><br><span class="line">                                <span class="comment">// 步骤10.3.4.2</span></span><br><span class="line">                                GroupHelper.AUTOGROUP_KEY,</span><br><span class="line">                                System.currentTimeMillis());</span><br><span class="line">                ......</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (summaryRecord != <span class="keyword">null</span> &amp;&amp; checkDisqualifyingFeatures(userId, MY_UID, summaryRecord.sbn.getId(), summaryRecord.sbn.getTag(), summaryRecord, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="comment">//  步骤10.3.4.3</span></span><br><span class="line">            mHandler.post(<span class="keyword">new</span> EnqueueNotificationRunnable(userId, summaryRecord));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>步骤10.3.4.1：拿到欲成组的子通知里面的第一条，然后将该子通知的各种属性复制给父通知，包括子通知的<strong>userId、extras、contentIntent</strong>等信息</li>
<li>步骤10.3.4.2：这里创建父通知时指定了<code>Notification</code>的<code>mGroupKey = GroupHelper.AUTOGROUP_KEY</code>，也就是<code>ranker_group</code>，同时指定了<code>StatusBarNotification</code>的<code>tag = GroupHelper.AUTOGROUP_KEY</code> 和 <code>overrideGroupKey = GroupHelper.AUTOGROUP_KEY</code>，这些信息在后续分析客户端通知显示的时候会用到</li>
<li>步骤10.3.4.3：父通知构建完成后，执行入列操作，这个就跟前面分析的新通知入列的流程是一样的了</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*GroupHelper.onNotificationPosted(...)*/</span></span><br><span class="line"><span class="comment">// 步骤10.3.5</span></span><br><span class="line">adjustNotificationBundling(notificationsToGroup, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<p>步骤10.3.5：看回前面的 步骤10.3.5，这里会去刷新所有刚被成组的所有子通知的属性，主要操作是执行了<code>StatusBarNotification</code>的<code>setOverrideGroupKey()</code>方法，将该值指定为<code>GroupHelper.AUTOGROUP_KEY</code>，所以到这里，所以成组的通知，包括父通知的<code>overrideGroupKey</code>就都变成了<code>ranker_group</code>，同样，这个属性将在<code>SystemUI</code>显示时发挥作用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*GroupHelper.onNotificationPosted(...)*/</span></span><br><span class="line"><span class="comment">// 步骤10.3.6</span></span><br><span class="line">maybeUngroup(sbn, <span class="keyword">false</span>, sbn.getUserId());</span><br></pre></td></tr></table></figure>

<p>步骤10.3.6：存在一种情况：某通知原来未指定group，然后被加进了系统创建的父通知里，但现在用户更新了该通知，并为其指定了group，也就是用户告诉系统，接下我自己要创建分组了，你把通知还给我。对于这种情况，系统需要将该通知从系统分组里面移除出来，避免出错。</p>
<p>至此，整个 <code>PostNotificationRunnable.run()</code> 方法就都分析完了，通知会发送给各个监听者，包括我们后面要讲的 <code>SystemUI</code>。</p>
<h6 id="SystemUI通知显示流程"><a href="#SystemUI通知显示流程" class="headerlink" title="SystemUI通知显示流程:"></a>SystemUI通知显示流程:</h6><p><img src="http://wxyy97.com/image/notification_systemui.jpg" alt=""><br><code>NotificationListeners mListeners;</code></p>
<p><code>mListeners.notifyPostedLocked(r, old);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationListeners</span> <span class="keyword">extends</span> <span class="title">ManagedServices</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> IInterface <span class="title">asInterface</span><span class="params">(IBinder binder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INotificationListener.Stub.asInterface(binder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceAdded</span><span class="params">(ManagedServiceInfo info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> INotificationListener listener = (INotificationListener) info.service;</span><br><span class="line">        <span class="keyword">final</span> NotificationRankingUpdate update;</span><br><span class="line">        <span class="keyword">synchronized</span> (mNotificationLock) &#123;</span><br><span class="line">            update = makeRankingUpdateLocked(info);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            listener.onListenerConnected(update);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// we tried</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * asynchronously notify all listeners about a new notification</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * Also takes care of removing a notification that has been visible to a listener before,</span></span><br><span class="line"><span class="comment">     * but isn't anymore.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GuardedBy</span>(<span class="string">"mNotificationLock"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyPostedLocked</span><span class="params">(NotificationRecord r, NotificationRecord old)</span> </span>&#123;</span><br><span class="line">        notifyPostedLocked(r, old, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notifyAllListeners notifies all listeners if true, else only notifies listeners</span></span><br><span class="line"><span class="comment">     *                           targetting &lt;= O_MR1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GuardedBy</span>(<span class="string">"mNotificationLock"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyPostedLocked</span><span class="params">(NotificationRecord r, NotificationRecord old,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> notifyAllListeners)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Lazily initialized snapshots of the notification.</span></span><br><span class="line">        StatusBarNotification sbn = r.sbn;</span><br><span class="line">        StatusBarNotification oldSbn = (old != <span class="keyword">null</span>) ? old.sbn : <span class="keyword">null</span>;</span><br><span class="line">        TrimCache trimCache = <span class="keyword">new</span> TrimCache(sbn);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> ManagedServiceInfo info : getServices()) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> sbnVisible = isVisibleToListener(sbn, info);</span><br><span class="line">            <span class="keyword">boolean</span> oldSbnVisible = oldSbn != <span class="keyword">null</span> ? isVisibleToListener(oldSbn, info) : <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// This notification hasn't been and still isn't visible -&gt; ignore.</span></span><br><span class="line">            <span class="keyword">if</span> (!oldSbnVisible &amp;&amp; !sbnVisible) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If the notification is hidden, don't notifyPosted listeners targeting &lt; P.</span></span><br><span class="line">            <span class="comment">// Instead, those listeners will receive notifyPosted when the notification is</span></span><br><span class="line">            <span class="comment">// unhidden.</span></span><br><span class="line">            <span class="keyword">if</span> (r.isHidden() &amp;&amp; info.targetSdkVersion &lt; Build.VERSION_CODES.P) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If we shouldn't notify all listeners, this means the hidden state of</span></span><br><span class="line">            <span class="comment">// a notification was changed.  Don't notifyPosted listeners targeting &gt;= P.</span></span><br><span class="line">            <span class="comment">// Instead, those listeners will receive notifyRankingUpdate.</span></span><br><span class="line">            <span class="keyword">if</span> (!notifyAllListeners &amp;&amp; info.targetSdkVersion &gt;= Build.VERSION_CODES.P) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> NotificationRankingUpdate update = makeRankingUpdateLocked(info);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This notification became invisible -&gt; remove the old one.</span></span><br><span class="line">            <span class="keyword">if</span> (oldSbnVisible &amp;&amp; !sbnVisible) &#123;</span><br><span class="line">                <span class="keyword">final</span> StatusBarNotification oldSbnLightClone = oldSbn.cloneLight();</span><br><span class="line">                mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        notifyRemoved(</span><br><span class="line">                                info, oldSbnLightClone, update, <span class="keyword">null</span>, REASON_USER_STOPPED);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Grant access before listener is notified</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> targetUserId = (info.userid == UserHandle.USER_ALL)</span><br><span class="line">                    ? UserHandle.USER_SYSTEM : info.userid;</span><br><span class="line">            updateUriPermissions(r, old, info.component.getPackageName(), targetUserId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> StatusBarNotification sbnToPost = trimCache.ForListener(info);</span><br><span class="line">            mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    notifyPosted(info, sbnToPost, update);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyPosted</span><span class="params">(<span class="keyword">final</span> ManagedServiceInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> StatusBarNotification sbn, NotificationRankingUpdate rankingUpdate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> INotificationListener listener = (INotificationListener) info.service;</span><br><span class="line">        StatusBarNotificationHolder sbnHolder = <span class="keyword">new</span> StatusBarNotificationHolder(sbn);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            listener.onNotificationPosted(sbnHolder, rankingUpdate);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"unable to notify listener (posted): "</span> + listener, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationListenerService</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationListenerWrapper</span> <span class="keyword">extends</span> <span class="title">INotificationListener</span>.<span class="title">Stub</span></span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/phone/NotificationListenerWithPlugins.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationListenerWithPlugins</span> <span class="keyword">extends</span> <span class="title">NotificationListenerService</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/NotificationListener.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotificationListener</span> <span class="keyword">extends</span> <span class="title">NotificationListenerWithPlugins</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//Systemui真正接收通知的地方</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotificationPosted</span><span class="params">(<span class="keyword">final</span> StatusBarNotification sbn,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> RankingMap rankingMap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"onNotificationPosted: "</span> + sbn);</span><br><span class="line">        <span class="keyword">if</span> (sbn != <span class="keyword">null</span> &amp;&amp; !onPluginNotificationPosted(sbn, rankingMap)) &#123;</span><br><span class="line">            Dependency.get(Dependency.MAIN_HANDLER).post(() -&gt; &#123;</span><br><span class="line">                processForRemoteInput(sbn.getNotification(), mContext);</span><br><span class="line">                String key = sbn.getKey();</span><br><span class="line">                <span class="keyword">boolean</span> isUpdate =</span><br><span class="line">                        mEntryManager.getNotificationData().get(key) != <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// In case we don't allow child notifications, we ignore children of</span></span><br><span class="line">                <span class="comment">// notifications that have a summary, since` we're not going to show them</span></span><br><span class="line">                <span class="comment">// anyway. This is true also when the summary is canceled,</span></span><br><span class="line">                <span class="comment">// because children are automatically canceled by NoMan in that case.</span></span><br><span class="line">                <span class="keyword">if</span> (!ENABLE_CHILD_NOTIFICATIONS</span><br><span class="line">                        &amp;&amp; mGroupManager.isChildInGroupWithSummary(sbn)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">"Ignoring group child due to existing summary: "</span> + sbn);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Remove existing notification to avoid stale data.</span></span><br><span class="line">                    <span class="keyword">if</span> (isUpdate) &#123;</span><br><span class="line">                        mEntryManager.removeNotification(key, rankingMap, UNDEFINED_DISMISS_REASON);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mEntryManager.getNotificationData()</span><br><span class="line">                                .updateRanking(rankingMap);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//判断更新还是添加</span></span><br><span class="line">                <span class="keyword">if</span> (isUpdate) &#123;</span><br><span class="line">                    mEntryManager.updateNotification(sbn, rankingMap);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mEntryManager.addNotification(sbn, rankingMap);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/notification/NotificationEntryManager.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addNotificationInternal</span><span class="params">(StatusBarNotification notification,</span></span></span><br><span class="line"><span class="function"><span class="params">            NotificationListenerService.RankingMap rankingMap)</span> <span class="keyword">throws</span> InflationException </span>&#123;</span><br><span class="line">        String key = notification.getKey();</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"addNotification key="</span> + key);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mNotificationData.updateRanking(rankingMap);</span><br><span class="line">        NotificationListenerService.Ranking ranking = <span class="keyword">new</span> NotificationListenerService.Ranking();</span><br><span class="line">        rankingMap.getRanking(key, ranking);</span><br><span class="line"></span><br><span class="line">        NotificationEntry entry = <span class="keyword">new</span> NotificationEntry(notification, ranking);</span><br><span class="line"></span><br><span class="line">        Dependency.get(LeakDetector<span class="class">.<span class="keyword">class</span>).<span class="title">trackInstance</span>(<span class="title">entry</span>)</span>;</span><br><span class="line">        <span class="comment">// Construct the expanded view.</span></span><br><span class="line">        requireBinder().inflateViews(entry, () -&gt; performRemoveNotification(notification,</span><br><span class="line">                REASON_CANCEL));</span><br><span class="line"></span><br><span class="line">        abortExistingInflation(key);</span><br><span class="line"></span><br><span class="line">        mPendingNotifications.put(key, entry);</span><br><span class="line">        <span class="keyword">for</span> (NotificationEntryListener listener : mNotificationEntryListeners) &#123;</span><br><span class="line">            listener.onPendingEntryAdded(entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/notification/collection/NotificationRowBinderImpl.java</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inflateViews</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            NotificationEntry entry,</span></span></span><br><span class="line"><span class="function"><span class="params">            Runnable onDismissRunnable)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> InflationException </span>&#123;</span><br><span class="line">        ViewGroup parent = mListContainer.getViewParentForNotification(entry);</span><br><span class="line">        PackageManager pmUser = StatusBar.getPackageManagerForUser(mContext,</span><br><span class="line">                entry.notification.getUser().getIdentifier());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> StatusBarNotification sbn = entry.notification;</span><br><span class="line">        <span class="keyword">if</span> (entry.rowExists()) &#123;</span><br><span class="line">            entry.updateIcons(mContext, sbn);</span><br><span class="line">            entry.reset();</span><br><span class="line">            updateNotification(entry, pmUser, sbn, entry.getRow());</span><br><span class="line">            entry.getRow().setOnDismissRunnable(onDismissRunnable);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            entry.createIcons(mContext, sbn);</span><br><span class="line">            <span class="keyword">new</span> RowInflaterTask().inflate(mContext, parent, entry,</span><br><span class="line">                    row -&gt; &#123;</span><br><span class="line">                        bindRow(entry, pmUser, sbn, row, onDismissRunnable);</span><br><span class="line">                        updateNotification(entry, pmUser, sbn, row);</span><br><span class="line">                    &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>最后bindRow就是去构造通知栏的通知View，然后updateNotification就是去显示到状态栏。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/notification/row/RowInflaterTask.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inflate</span><span class="params">(Context context, ViewGroup parent, NotificationEntry entry,</span></span></span><br><span class="line"><span class="function"><span class="params">            RowInflationFinishedListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (TRACE_ORIGIN) &#123;</span><br><span class="line">            mInflateOrigin = <span class="keyword">new</span> Throwable(<span class="string">"inflate requested here"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mListener = listener;</span><br><span class="line">        AsyncLayoutInflater inflater = <span class="keyword">new</span> AsyncLayoutInflater(context);</span><br><span class="line">        mEntry = entry;</span><br><span class="line">        entry.setInflationTask(<span class="keyword">this</span>);</span><br><span class="line">        inflater.inflate(R.layout.status_bar_notification_row, parent, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateNotification</span><span class="params">(Entry entry, PackageManager pmUser,</span></span></span><br><span class="line"><span class="function"><span class="params">     StatusBarNotification sbn, ExpandableNotificationRow row)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        row.updateNotification(entry);</span><br><span class="line">&#125;</span><br><span class="line">------------</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateNotification</span><span class="params">(NotificationData.Entry entry)</span> </span>&#123;</span><br><span class="line">    mEntry = entry;</span><br><span class="line">    mStatusBarNotification = entry.notification;</span><br><span class="line">    mNotificationInflater.inflateNotificationViews();</span><br><span class="line">&#125;</span><br><span class="line">------------</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inflateNotificationViews</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    inflateNotificationViews(FLAG_REINFLATE_ALL);</span><br><span class="line">&#125;</span><br><span class="line">------------</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inflateNotificationViews</span><span class="params">(<span class="keyword">int</span> reInflateFlags)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    StatusBarNotification sbn = mRow.getEntry().notification;</span><br><span class="line">    <span class="keyword">new</span> AsyncInflationTask(sbn, reInflateFlags, mRow, mIsLowPriority,</span><br><span class="line">            mIsChildInGroup, mUsesIncreasedHeight, mUsesIncreasedHeadsUpHeight, mRedactAmbient,</span><br><span class="line">            mCallback, mRemoteViewClickHandler).execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">AsyncInflationTask</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> InflationProgress <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> createRemoteViews(mReInflateFlags,</span><br><span class="line">     recoveredBuilder, mIsLowPriority, mIsChildInGroup,</span><br><span class="line">     mUsesIncreasedHeight, mUsesIncreasedHeadsUpHeight, mRedactAmbient,</span><br><span class="line">     packageContext);</span><br><span class="line">&#125;</span><br><span class="line">------------</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InflationProgress <span class="title">createRemoteViews</span><span class="params">(<span class="keyword">int</span> reInflateFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            Notification.Builder builder, <span class="keyword">boolean</span> isLowPriority, <span class="keyword">boolean</span> isChildInGroup,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> usesIncreasedHeight, <span class="keyword">boolean</span> usesIncreasedHeadsUpHeight, <span class="keyword">boolean</span> redactAmbient,</span></span></span><br><span class="line"><span class="function"><span class="params">            Context packageContext)</span> </span>&#123;</span><br><span class="line">        InflationProgress result = <span class="keyword">new</span> InflationProgress();</span><br><span class="line">        isLowPriority = isLowPriority &amp;&amp; !isChildInGroup;</span><br><span class="line">        <span class="keyword">if</span> ((reInflateFlags &amp; FLAG_REINFLATE_CONTENT_VIEW) != <span class="number">0</span>) &#123;</span><br><span class="line">            result.newContentView = createContentView(builder, isLowPriority, usesIncreasedHeight);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((reInflateFlags &amp; FLAG_REINFLATE_EXPANDED_VIEW) != <span class="number">0</span>) &#123;</span><br><span class="line">            result.newExpandedView = createExpandedView(builder, isLowPriority);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((reInflateFlags &amp; FLAG_REINFLATE_HEADS_UP_VIEW) != <span class="number">0</span>) &#123;</span><br><span class="line">            result.newHeadsUpView = builder.createHeadsUpContentView(usesIncreasedHeadsUpHeight);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((reInflateFlags &amp; FLAG_REINFLATE_PUBLIC_VIEW) != <span class="number">0</span>) &#123;</span><br><span class="line">            result.newPublicView = builder.makePublicContentView();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((reInflateFlags &amp; FLAG_REINFLATE_AMBIENT_VIEW) != <span class="number">0</span>) &#123;</span><br><span class="line">            result.newAmbientView = redactAmbient ? builder.makePublicAmbientNotification()</span><br><span class="line">                    : builder.makeAmbientNotification();</span><br><span class="line">        &#125;</span><br><span class="line">        result.packageContext = packageContext;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//frameworks/base/core/java/android/app/Notification.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RemoteViews <span class="title">createContentView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> createContentView(<span class="keyword">false</span> <span class="comment">/* increasedheight */</span> );</span><br><span class="line">&#125;</span><br><span class="line">------------</span><br><span class="line"><span class="function"><span class="keyword">public</span> RemoteViews <span class="title">createContentView</span><span class="params">(<span class="keyword">boolean</span> increasedHeight)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mN.contentView != <span class="keyword">null</span> &amp;&amp; useExistingRemoteView()) &#123;</span><br><span class="line">        <span class="keyword">return</span> mN.contentView;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mStyle != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> RemoteViews styleView = mStyle.makeContentView(increasedHeight);</span><br><span class="line">        <span class="keyword">if</span> (styleView != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> styleView;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> applyStandardTemplate(getBaseLayoutResource());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//默认的通知布局</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getBaseLayoutResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> R.layout.notification_template_material_base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/status_bar_latest_event_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:tag</span>=<span class="string">"base"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/notification_template_header"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/notification_main_column"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_gravity</span>=<span class="string">"top"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginStart</span>=<span class="string">"@dimen/notification_content_margin_start"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginEnd</span>=<span class="string">"@dimen/notification_content_margin_end"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"@dimen/notification_content_margin_top"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginBottom</span>=<span class="string">"@dimen/notification_content_margin"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:orientation</span>=<span class="string">"vertical"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/notification_template_part_line1"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/notification_template_text"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"@dimen/notification_progress_bar_height"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"@dimen/notification_progress_margin_top"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">layout</span>=<span class="string">"@layout/notification_template_progress"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/notification_template_smart_reply_container"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"@dimen/notification_content_margin"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">layout</span>=<span class="string">"@layout/notification_template_right_icon"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>从上面的布局可看出分为三部分，头部、主内容、右图标。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/10/14/Settings10%E4%B8%BB%E7%95%8C%E9%9D%A2%E5%8A%A0%E8%BD%BD(%E4%BA%8C)/" rel="prev" title="Settings10主界面加载(二)">
      <i class="fa fa-chevron-left"></i> Settings10主界面加载(二)
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/10/NotificationManagerService%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B/" rel="next" title="NotificationManagerService注册流程">
      NotificationManagerService注册流程 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-5"><a class="nav-link" href="#一、通知栏界面如下："><span class="nav-number">1.</span> <span class="nav-text">一、通知栏界面如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#二、Notification"><span class="nav-number">2.</span> <span class="nav-text">二、Notification</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1、使用：Notification-Rain-G"><span class="nav-number">2.1.</span> <span class="nav-text">1、使用：Notification | Rain.G</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2、实现原理："><span class="nav-number">2.2.</span> <span class="nav-text">2、实现原理：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#SystemUI通知显示流程"><span class="nav-number">2.3.</span> <span class="nav-text">SystemUI通知显示流程:</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Rain.G"
      src="/images/wx.JPG">
  <p class="site-author-name" itemprop="name">Rain.G</p>
  <div class="site-description" itemprop="description">愿你一生努力，一生被爱</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/rain-G-G" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rain-G-G" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-heartbeat fa-fw"></i>
      友情链接
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.csdn.net/sinat_37781304/article/details/82729029?depth_1-utm_source=distribute.wap_relevant.none-task-blog-BlogCommendFromBaidu-1&utm_source=distribute.wap_relevant.none-task-blog-BlogCommendFromBaidu-1&from=singlemessage&isappinstalled=0" title="https:&#x2F;&#x2F;blog.csdn.net&#x2F;sinat_37781304&#x2F;article&#x2F;details&#x2F;82729029?depth_1-utm_source&#x3D;distribute.wap_relevant.none-task-blog-BlogCommendFromBaidu-1&amp;utm_source&#x3D;distribute.wap_relevant.none-task-blog-BlogCommendFromBaidu-1&amp;from&#x3D;singlemessage&amp;isappinstalled&#x3D;0" rel="noopener" target="_blank">Hexo搭建</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.jianshu.com/p/85ea951ce996?from=singlemessage&isappinstalled=0" title="https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;85ea951ce996?from&#x3D;singlemessage&amp;isappinstalled&#x3D;0" rel="noopener" target="_blank">NexT美化</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rain.G</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
